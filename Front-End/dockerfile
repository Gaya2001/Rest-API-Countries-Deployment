# Stage 1: Build the app using Vite
FROM node:22.12.0-alpine  as build

WORKDIR /app

# Accept environment variables passed during build time
ARG VITE_API_URL
ARG VITE_SERVER_URL

# Use the build-time variables
ENV VITE_API_URL=${VITE_API_URL}
ENV VITE_SERVER_URL=${VITE_SERVER_URL}

# Install dependencies
COPY package.json package-lock.json ./
RUN npm install

# Copy the source code into the container
COPY . .

# Build the frontend using Vite
RUN npm run build




# Stage 2: Use Nginx to serve the built app
FROM nginx:alpine

# Copy built files from the previous stage to Nginx's default directory
COPY --from=build /app/dist /usr/share/nginx/html

# Nginx Configuration: Serve index.html for all SPA routes
RUN echo 'server {\n\
    listen 80;\n\
    server_name localhost;\n\
    root /usr/share/nginx/html;\n\
    \n\
    # Serve index.html for all routes, including routes that are handled by React Router\n\
    location / {\n\
    try_files $uri $uri/ /index.html;  # If file not found, serve index.html\n\
    }\n\
    \n\
    # Optional: Handle 404 for missing static files (like CSS, JS)\n\
    error_page 404 /index.html;\n\
    }' > /etc/nginx/conf.d/default.conf

# Expose port 80 for Nginx
EXPOSE 80

# Run Nginx in the foreground
CMD ["nginx", "-g", "daemon off;"]
